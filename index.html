<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æˆç¸¾ç®¡ç†ç³»çµ±</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0f1117;--s1:#161b27;--s2:#1c2334;--s3:#222c3f;
  --b1:#2a3549;--b2:#334060;--b3:#3d4e74;
  --acc:#3b82f6;--acc2:#06b6d4;--grn:#22c55e;--red:#ef4444;--ylw:#f59e0b;--pur:#a855f7;
  --t1:#f0f4ff;--t2:#94a3b8;--t3:#4b5a74;
  --r:10px;--rs:6px;--shadow:0 4px 24px rgba(0,0,0,.4);
}
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Noto Sans TC',sans-serif;background:var(--bg);color:var(--t1);min-height:100vh;font-size:14px;}
.mono{font-family:'JetBrains Mono',monospace;}
.hidden{display:none!important;}
@keyframes fadeUp{from{opacity:0;transform:translateY(14px);}to{opacity:1;transform:translateY(0);}}
@keyframes spin{to{transform:rotate(360deg);}}
.fade-up{animation:fadeUp .35s ease both;}

/* NAV */
.topnav{position:fixed;top:0;left:0;right:0;height:56px;z-index:50;background:rgba(15,17,23,.95);backdrop-filter:blur(12px);border-bottom:1px solid var(--b1);display:flex;align-items:center;padding:0 24px;gap:16px;}
.topnav .logo{font-size:15px;font-weight:700;letter-spacing:1px;}
.topnav .logo em{font-style:normal;color:var(--acc);}
.topnav-right{margin-left:auto;display:flex;align-items:center;gap:12px;}
.user-pill{display:flex;align-items:center;gap:8px;padding:5px 12px;background:var(--s2);border:1px solid var(--b1);border-radius:20px;}
.user-pill img{width:24px;height:24px;border-radius:50%;}
.user-pill span{font-size:13px;color:var(--t2);}

/* SIDEBAR */
.layout{display:flex;padding-top:56px;min-height:100vh;}
.sidebar{width:220px;flex-shrink:0;background:var(--s1);border-right:1px solid var(--b1);padding:20px 12px;position:fixed;top:56px;bottom:0;overflow-y:auto;}
.sidebar-label{font-size:10px;letter-spacing:3px;color:var(--t3);padding:10px 12px 4px;font-family:'JetBrains Mono',monospace;}
.nav-item{display:flex;align-items:center;gap:10px;padding:9px 12px;border-radius:var(--rs);color:var(--t2);cursor:pointer;transition:all .15s;font-size:13px;font-weight:500;border:1px solid transparent;margin-bottom:2px;}
.nav-item:hover{background:var(--s2);color:var(--t1);}
.nav-item.active{background:rgba(59,130,246,.12);color:var(--acc);border-color:rgba(59,130,246,.25);}
.nav-item .ico{font-size:15px;width:20px;text-align:center;}
.main{margin-left:220px;padding:28px;flex:1;}
.page{display:none;}
.page.active{display:block;animation:fadeUp .3s ease;}

/* PAGE HEADER */
.ph{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:24px;flex-wrap:wrap;gap:12px;}
.ph-left h2{font-size:20px;font-weight:700;}
.ph-left p{color:var(--t2);font-size:13px;margin-top:3px;}

/* CARDS */
.card{background:var(--s1);border:1px solid var(--b1);border-radius:var(--r);padding:20px;}

/* BUTTONS */
.btn{display:inline-flex;align-items:center;gap:6px;padding:8px 16px;border-radius:var(--rs);font-size:13px;font-weight:500;cursor:pointer;transition:all .15s;border:none;font-family:'Noto Sans TC',sans-serif;}
.btn-primary{background:var(--acc);color:#fff;}
.btn-primary:hover{background:#2563eb;transform:translateY(-1px);}
.btn-ghost{background:transparent;border:1px solid var(--b2);color:var(--t2);}
.btn-ghost:hover{border-color:var(--b3);color:var(--t1);}
.btn-danger{background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.3);color:var(--red);}
.btn-danger:hover{background:rgba(239,68,68,.2);}
.btn-sm{padding:6px 13px;font-size:12px;}
.btn-xs{padding:3px 9px;font-size:11px;}

/* FORMS */
.form-row{display:grid;gap:14px;margin-bottom:14px;}
.g2{grid-template-columns:1fr 1fr;}
.g3{grid-template-columns:1fr 1fr 1fr;}
.gfull{grid-column:1/-1;}
.fg{display:flex;flex-direction:column;gap:5px;}
.fg label{font-size:11px;letter-spacing:2px;color:var(--t3);font-family:'JetBrains Mono',monospace;}
.fg input,.fg select,.fg textarea{padding:9px 12px;background:var(--bg);border:1px solid var(--b1);border-radius:var(--rs);color:var(--t1);font-size:13px;font-family:'Noto Sans TC',sans-serif;outline:none;transition:border-color .15s,box-shadow .15s;}
.fg input:focus,.fg select:focus,.fg textarea:focus{border-color:var(--acc);box-shadow:0 0 0 3px rgba(59,130,246,.12);}
.fg input:disabled{opacity:.4;cursor:not-allowed;}
.fg select option{background:var(--s2);}
.fg textarea{resize:vertical;font-family:'JetBrains Mono',monospace;font-size:12px;}

/* TABLES */
.tbl-wrap{overflow-x:auto;border-radius:var(--rs);border:1px solid var(--b1);}
table{width:100%;border-collapse:collapse;}
thead th{padding:10px 14px;text-align:left;font-size:10px;letter-spacing:2px;color:var(--t3);font-family:'JetBrains Mono',monospace;background:var(--s2);font-weight:400;white-space:nowrap;}
tbody tr{border-top:1px solid var(--b1);transition:background .12s;}
tbody tr:hover{background:rgba(255,255,255,.02);}
tbody td{padding:11px 14px;font-size:13px;vertical-align:middle;}
tfoot td{padding:11px 14px;font-size:13px;background:var(--s2);border-top:2px solid var(--b2);font-family:'JetBrains Mono',monospace;font-weight:600;color:var(--acc2);}

/* SCORE INPUT */
.si{width:72px;padding:5px 8px;background:var(--s2);border:1px solid var(--b1);border-radius:4px;color:var(--t1);font-size:13px;font-family:'JetBrains Mono',monospace;text-align:center;outline:none;transition:border-color .15s;}
.si:focus{border-color:var(--acc);}
.si.filled{border-color:var(--b3);background:var(--s3);}

/* BADGES */
.badge{display:inline-flex;align-items:center;padding:2px 8px;border-radius:12px;font-size:11px;font-family:'JetBrains Mono',monospace;}
.bb{background:rgba(59,130,246,.15);color:#93c5fd;}
.bg{background:rgba(34,197,94,.15);color:#86efac;}
.br{background:rgba(239,68,68,.15);color:#fca5a5;}
.by{background:rgba(245,158,11,.15);color:#fcd34d;}
.bp{background:rgba(168,85,247,.15);color:#d8b4fe;}
.bgr{background:rgba(148,163,184,.1);color:var(--t2);}

/* TOAST */
.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(12px);background:var(--s2);border:1px solid var(--b2);border-radius:var(--r);padding:11px 20px;font-size:13px;opacity:0;transition:all .25s;pointer-events:none;z-index:999;white-space:nowrap;box-shadow:var(--shadow);}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0);}
.toast.ok{border-color:rgba(34,197,94,.4);color:var(--grn);}
.toast.err{border-color:rgba(239,68,68,.4);color:var(--red);}

/* MODAL */
.modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.75);backdrop-filter:blur(4px);z-index:100;display:flex;align-items:center;justify-content:center;padding:20px;}
.modal{background:var(--s1);border:1px solid var(--b2);border-radius:14px;padding:28px;width:100%;max-width:500px;max-height:90vh;overflow-y:auto;box-shadow:0 32px 64px rgba(0,0,0,.5);animation:fadeUp .25s ease;}
.modal h3{font-size:16px;font-weight:700;margin-bottom:20px;padding-bottom:14px;border-bottom:1px solid var(--b1);}
.modal-foot{display:flex;justify-content:flex-end;gap:10px;margin-top:20px;padding-top:16px;border-top:1px solid var(--b1);}

/* LOGIN */
.center-screen{min-height:100vh;display:flex;align-items:center;justify-content:center;background:var(--bg);background-image:radial-gradient(ellipse at 20% 30%,rgba(59,130,246,.07) 0%,transparent 60%),radial-gradient(ellipse at 80% 70%,rgba(6,182,212,.05) 0%,transparent 60%);}
.auth-box{width:100%;max-width:400px;padding:40px;background:var(--s1);border:1px solid var(--b1);border-radius:16px;box-shadow:var(--shadow);text-align:center;}
.auth-box h1{font-size:24px;font-weight:700;margin-bottom:6px;}
.auth-box h1 em{font-style:normal;color:var(--acc);}
.auth-box .sub{color:var(--t2);font-size:13px;margin-bottom:28px;line-height:1.7;}
.btn-google{display:flex;align-items:center;justify-content:center;gap:12px;width:100%;padding:13px;background:#fff;border:none;border-radius:var(--rs);color:#3c4043;font-size:14px;font-weight:600;cursor:pointer;transition:box-shadow .15s,transform .1s;font-family:'Noto Sans TC',sans-serif;}
.btn-google:hover{box-shadow:0 4px 20px rgba(255,255,255,.15);transform:translateY(-1px);}
.btn-google svg{width:20px;height:20px;}

/* STUDENT VIEW */
.stu-score-item{background:var(--s2);border:1px solid var(--b1);border-radius:var(--rs);padding:14px 18px;display:flex;align-items:center;gap:16px;margin-bottom:10px;}
.stu-score-item .pts{font-size:20px;font-weight:700;font-family:'JetBrains Mono',monospace;min-width:60px;text-align:right;}
.pts-high{color:var(--grn);}
.pts-mid{color:var(--ylw);}
.pts-low{color:var(--red);}
.pts-none{color:var(--t3);font-size:13px;}

/* TABS */
.tabs{display:flex;gap:2px;background:var(--s2);padding:4px;border-radius:var(--rs);margin-bottom:20px;width:fit-content;}
.tab{padding:7px 16px;border-radius:5px;font-size:13px;cursor:pointer;color:var(--t2);transition:all .15s;font-weight:500;}
.tab.active{background:var(--s3);color:var(--t1);box-shadow:0 1px 4px rgba(0,0,0,.3);}

@media(max-width:768px){
  .sidebar{display:none;}
  .main{margin-left:0;}
  .form-row.g2,.form-row.g3{grid-template-columns:1fr;}
}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="S-login" class="center-screen fade-up">
  <div class="auth-box">
    <h1>æˆç¸¾<em>ç®¡ç†</em>ç³»çµ±</h1>
    <p class="sub">è«‹ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥</p>
    <button class="btn-google" onclick="doSignIn()">
      <svg viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.18 1.48-4.97 2.31-8.16 2.31-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/></svg>
      ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥
    </button>
    <div id="loginErr" style="color:var(--red);font-size:12px;margin-top:10px;"></div>
  </div>
</div>

<!-- BIND (student without binding) -->
<div id="S-bind" class="center-screen hidden">
  <div class="auth-box fade-up" style="max-width:460px;text-align:left;">
    <h1 style="font-size:20px;">ğŸ”— ç¶å®šå­¸ç”Ÿå¸³è™Ÿ</h1>
    <p class="sub" style="text-align:left;">ä½ çš„å¸³è™Ÿå°šæœªç¶å®šå­¸ç”Ÿè³‡æ–™ï¼Œè«‹å¡«å¯«ä»¥ä¸‹è³‡è¨Šå®Œæˆç¶å®šã€‚</p>
    <div style="background:var(--s2);border:1px solid var(--b1);border-radius:var(--rs);padding:10px 14px;margin-bottom:18px;font-size:12px;color:var(--t2);font-family:'JetBrains Mono',monospace;" id="bindInfo"></div>
    <div class="form-row g2">
      <div class="fg"><label>ç­ç´š</label><select id="bindClass"></select></div>
      <div class="fg"><label>åº§è™Ÿ</label><input type="number" id="bindSeat" placeholder="1~50" min="1" max="50"></div>
    </div>
    <div class="form-row"><div class="fg"><label>å§“åï¼ˆèˆ‡åå–®ç›¸ç¬¦ï¼‰</label><input type="text" id="bindName" placeholder="è«‹è¼¸å…¥å§“å"></div></div>
    <div style="display:flex;gap:10px;">
      <button class="btn btn-primary" style="flex:1" onclick="doBind()">ç¢ºèªç¶å®š</button>
      <button class="btn btn-ghost" onclick="doSignOut()">ç™»å‡º</button>
    </div>
    <div id="bindErr" style="color:var(--red);font-size:12px;margin-top:10px;"></div>
  </div>
</div>

<!-- STUDENT VIEW -->
<div id="S-student" class="hidden">
  <div class="topnav">
    <div class="logo">æˆç¸¾<em>æŸ¥è©¢</em></div>
    <div class="topnav-right">
      <span id="stuEmail" style="font-size:12px;color:var(--t3);"></span>
      <button class="btn btn-ghost btn-sm" onclick="doSignOut()">ç™»å‡º</button>
    </div>
  </div>
  <div style="padding:72px 20px 40px;max-width:680px;margin:0 auto;" class="fade-up">
    <div style="margin-bottom:20px;">
      <h2 id="stuInfoName" style="font-size:20px;font-weight:700;"></h2>
      <p id="stuInfoMeta" style="color:var(--t2);font-size:13px;margin-top:3px;"></p>
    </div>
    <div class="tabs">
      <div class="tab active" data-type="hw" onclick="stuSwitchTab(this,'hw')">ğŸ“ ä½œæ¥­</div>
      <div class="tab" data-type="exam" onclick="stuSwitchTab(this,'exam')">ğŸ“‹ è€ƒè©¦</div>
      <div class="tab" data-type="perf" onclick="stuSwitchTab(this,'perf')">â­ å¹³æ™‚</div>
      <div class="tab" data-type="att" onclick="stuSwitchTab(this,'att')">ğŸ“… å‡ºç¼ºå‹¤</div>
    </div>
    <div id="stuScoreList"></div>
    <div id="stuEmpty" class="hidden" style="text-align:center;padding:48px;color:var(--t3);font-size:13px;">æ­¤é¡åˆ¥å°šç„¡æˆç¸¾</div>
  </div>
</div>

<!-- ADMIN -->
<div id="S-admin" class="hidden">
  <div class="topnav">
    <div class="logo">æˆç¸¾<em>ç®¡ç†</em>ç³»çµ±</div>
    <div class="topnav-right">
      <div class="user-pill"><img id="adminAvatar" src="" alt=""><span id="adminName"></span></div>
      <button class="btn btn-ghost btn-sm" onclick="doSignOut()">ç™»å‡º</button>
    </div>
  </div>
  <div class="layout">
    <div class="sidebar">
      <div class="sidebar-label">æˆç¸¾</div>
      <div class="nav-item active" data-page="scoreEntry" onclick="navTo('scoreEntry')"><span class="ico">ğŸ“Š</span>å…¨ç­æˆç¸¾è¼¸å…¥</div>
      <div class="nav-item" data-page="assignments" onclick="navTo('assignments')"><span class="ico">ğŸ“</span>ä½œæ¥­ç®¡ç†</div>
      <div class="sidebar-label">å­¸ç”Ÿ</div>
      <div class="nav-item" data-page="students" onclick="navTo('students')"><span class="ico">ğŸ‘¥</span>å­¸ç”Ÿåå–®</div>
      <div class="nav-item" data-page="bindings" onclick="navTo('bindings')"><span class="ico">ğŸ”—</span>å¸³è™Ÿç¶å®š</div>
      <div class="sidebar-label">è¨­å®š</div>
      <div class="nav-item" data-page="classes" onclick="navTo('classes')"><span class="ico">ğŸ«</span>ç­ç´šç®¡ç†</div>
    </div>
    <div class="main">

      <!-- PAGE: å…¨ç­æˆç¸¾è¼¸å…¥ -->
      <div class="page active" id="page-scoreEntry">
        <div class="ph"><div class="ph-left"><h2>ğŸ“Š å…¨ç­æˆç¸¾è¼¸å…¥</h2><p>é¸æ“‡ç­ç´šèˆ‡é …ç›®ï¼Œå¡«å…¥æ¯ä½å­¸ç”Ÿåˆ†æ•¸</p></div></div>
        <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end;margin-bottom:20px;">
          <div class="fg" style="min-width:110px;"><label>ç­ç´š</label><select id="seClass" onchange="seLoadItems()"></select></div>
          <div class="fg" style="min-width:200px;"><label>ä½œæ¥­ / è€ƒè©¦é …ç›®</label><select id="seItem" onchange="seLoadSheet()"></select></div>
          <button class="btn btn-primary" onclick="seSave()">ğŸ’¾ å„²å­˜å…¨ç­æˆç¸¾</button>
        </div>
        <div id="seSheet"><div style="text-align:center;padding:48px;color:var(--t3);">è«‹å…ˆé¸æ“‡ç­ç´šèˆ‡é …ç›®</div></div>
      </div>

      <!-- PAGE: ä½œæ¥­ç®¡ç† -->
      <div class="page" id="page-assignments">
        <div class="ph">
          <div class="ph-left"><h2>ğŸ“ ä½œæ¥­ç®¡ç†</h2><p>æ–°å¢ä½œæ¥­ã€è€ƒè©¦ã€å¹³æ™‚æˆ–å‡ºç¼ºå‹¤é …ç›®</p></div>
          <button class="btn btn-primary" onclick="openAsgModal()">ï¼‹ æ–°å¢é …ç›®</button>
        </div>
        <div style="margin-bottom:14px;"><div class="fg" style="max-width:150px;"><label>ç¯©é¸ç­ç´š</label><select id="asgFilter" onchange="loadAsgList()"></select></div></div>
        <div class="tbl-wrap"><table><thead><tr><th>åç¨±</th><th>é¡å‹</th><th>ç­ç´š</th><th>æ»¿åˆ†</th><th>å»ºç«‹</th><th></th></tr></thead><tbody id="asgTbody"></tbody></table></div>
      </div>

      <!-- PAGE: å­¸ç”Ÿåå–® -->
      <div class="page" id="page-students">
        <div class="ph">
          <div class="ph-left"><h2>ğŸ‘¥ å­¸ç”Ÿåå–®</h2><p>ç®¡ç†å­¸ç”ŸåŸºæœ¬è³‡æ–™</p></div>
          <div style="display:flex;gap:8px;">
            <button class="btn btn-ghost" onclick="openImportModal()">ğŸ“‹ æ‰¹æ¬¡åŒ¯å…¥</button>
            <button class="btn btn-primary" onclick="openStuModal()">ï¼‹ æ–°å¢</button>
          </div>
        </div>
        <div style="margin-bottom:14px;"><div class="fg" style="max-width:150px;"><label>ç¯©é¸ç­ç´š</label><select id="stuFilter" onchange="loadStuList()"></select></div></div>
        <div class="tbl-wrap"><table><thead><tr><th>åº§è™Ÿ</th><th>å§“å</th><th>ç­ç´š</th><th>ç¶å®šç‹€æ…‹</th><th></th></tr></thead><tbody id="stuTbody"></tbody></table></div>
      </div>

      <!-- PAGE: å¸³è™Ÿç¶å®š -->
      <div class="page" id="page-bindings">
        <div class="ph"><div class="ph-left"><h2>ğŸ”— å¸³è™Ÿç¶å®šç®¡ç†</h2><p>æŸ¥çœ‹ã€ä¿®æ”¹æˆ–ç§»é™¤å­¸ç”Ÿçš„ Google å¸³è™Ÿç¶å®š</p></div></div>
        <div style="margin-bottom:14px;"><div class="fg" style="max-width:150px;"><label>ç¯©é¸ç­ç´š</label><select id="bindFilter" onchange="loadBindList()"></select></div></div>
        <div class="tbl-wrap"><table><thead><tr><th>åº§è™Ÿ</th><th>å§“å</th><th>ç­ç´š</th><th>ç¶å®š Google å¸³è™Ÿ</th><th>ç¶å®šæ™‚é–“</th><th></th></tr></thead><tbody id="bindTbody"></tbody></table></div>
      </div>

      <!-- PAGE: ç­ç´šç®¡ç† -->
      <div class="page" id="page-classes">
        <div class="ph">
          <div class="ph-left"><h2>ğŸ« ç­ç´šç®¡ç†</h2><p>æ–°å¢æˆ–åˆªé™¤ç­ç´š</p></div>
          <button class="btn btn-primary" onclick="openClsModal()">ï¼‹ æ–°å¢ç­ç´š</button>
        </div>
        <div id="clsList" style="display:flex;flex-direction:column;gap:10px;"></div>
      </div>

    </div>
  </div>
</div>

<!-- MODALS -->
<!-- Assignment -->
<div class="modal-bg hidden" id="M-asg" onclick="mbg(event,'M-asg')">
  <div class="modal"><h3 id="asgMT">æ–°å¢é …ç›®</h3>
    <div class="form-row"><div class="fg"><label>åç¨±</label><input type="text" id="asgName" placeholder="ç¬¬ä¸€æ¬¡ä½œæ¥­"></div></div>
    <div class="form-row g3">
      <div class="fg"><label>é¡å‹</label><select id="asgType"><option value="hw">ğŸ“ ä½œæ¥­</option><option value="exam">ğŸ“‹ è€ƒè©¦</option><option value="perf">â­ å¹³æ™‚</option><option value="att">ğŸ“… å‡ºç¼ºå‹¤</option></select></div>
      <div class="fg"><label>ç­ç´š</label><select id="asgClass"></select></div>
      <div class="fg"><label>æ»¿åˆ†</label><input type="number" id="asgMax" value="100" min="1"></div>
    </div>
    <div class="modal-foot"><button class="btn btn-ghost" onclick="cm('M-asg')">å–æ¶ˆ</button><button class="btn btn-primary" onclick="saveAsg()">å„²å­˜</button></div>
  </div>
</div>

<!-- Student -->
<div class="modal-bg hidden" id="M-stu" onclick="mbg(event,'M-stu')">
  <div class="modal"><h3 id="stuMT">æ–°å¢å­¸ç”Ÿ</h3>
    <div class="form-row g2">
      <div class="fg"><label>ç­ç´š</label><select id="stuCls"></select></div>
      <div class="fg"><label>åº§è™Ÿ</label><input type="number" id="stuSeat" min="1" max="50" placeholder="1~50"></div>
    </div>
    <div class="form-row"><div class="fg"><label>å§“å</label><input type="text" id="stuName2" placeholder="ç‹å°æ˜"></div></div>
    <div class="modal-foot"><button class="btn btn-ghost" onclick="cm('M-stu')">å–æ¶ˆ</button><button class="btn btn-primary" onclick="saveStu()">å„²å­˜</button></div>
  </div>
</div>

<!-- Import -->
<div class="modal-bg hidden" id="M-import" onclick="mbg(event,'M-import')">
  <div class="modal" style="max-width:560px;"><h3>ğŸ“‹ æ‰¹æ¬¡åŒ¯å…¥å­¸ç”Ÿ</h3>
    <p style="color:var(--t2);font-size:12px;margin-bottom:12px;line-height:1.8;">æ¯è¡Œä¸€ç­†ï¼Œæ ¼å¼ï¼š<code style="color:var(--acc);">åº§è™Ÿ å§“å ç­ç´š</code><br>ä¾‹ï¼š<code style="color:var(--acc2);">1 å³å®¥ç£¬ 804</code></p>
    <div class="fg"><label>è²¼ä¸Šåå–®</label><textarea id="importTxt" rows="10" placeholder="1 å³å®¥ç£¬ 804&#10;2 æ—ç¾¿å®‡ 804&#10;1 æå®¥è± 806"></textarea></div>
    <div id="importResult" style="margin-top:10px;max-height:160px;overflow-y:auto;font-size:12px;font-family:'JetBrains Mono',monospace;"></div>
    <div class="modal-foot"><button class="btn btn-ghost" onclick="cm('M-import')">é—œé–‰</button><button class="btn btn-primary" onclick="runImport()">é–‹å§‹åŒ¯å…¥</button></div>
  </div>
</div>

<!-- Class -->
<div class="modal-bg hidden" id="M-cls" onclick="mbg(event,'M-cls')">
  <div class="modal" style="max-width:360px;"><h3>æ–°å¢ç­ç´š</h3>
    <div class="fg"><label>ç­ç´šåç¨±</label><input type="text" id="clsName" placeholder="ä¾‹ï¼š805"></div>
    <div class="modal-foot"><button class="btn btn-ghost" onclick="cm('M-cls')">å–æ¶ˆ</button><button class="btn btn-primary" onclick="saveCls()">æ–°å¢</button></div>
  </div>
</div>

<!-- Rebind -->
<div class="modal-bg hidden" id="M-rebind" onclick="mbg(event,'M-rebind')">
  <div class="modal" style="max-width:400px;"><h3>ä¿®æ”¹ç¶å®šå¸³è™Ÿ</h3>
    <p style="color:var(--t2);font-size:13px;margin-bottom:14px;">ä¿®æ”¹å¾Œå­¸ç”Ÿä¸‹æ¬¡ç™»å…¥å³ç”Ÿæ•ˆã€‚</p>
    <input type="hidden" id="rebindUid">
    <div class="fg"><label>æ–° Google Email</label><input type="email" id="rebindEmail" placeholder="student@gmail.com"></div>
    <div class="modal-foot"><button class="btn btn-ghost" onclick="cm('M-rebind')">å–æ¶ˆ</button><button class="btn btn-primary" onclick="saveRebind()">ç¢ºèª</button></div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, signOut as fbOut, onAuthStateChanged }
  from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
import {
  getFirestore, collection, doc, getDocs, getDoc, setDoc, deleteDoc,
  query, where, orderBy, serverTimestamp, writeBatch
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   â˜… å¡«å…¥ä½ çš„ Firebase è¨­å®š
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const FB = {
  apiKey:"AIzaSyC0AF7-_ZzkeiInZRacvEtxSG8vVBloRFM",
  authDomain:"gradelookup-bf204.firebaseapp.com",
  projectId:"gradelookup-bf204",
  storageBucket:"gradelookup-bf204.firebasestorage.app",
  messagingSenderId:"170384586457",
  appId:"1:170384586457:web:ffe28a5f79156b6ee570c8"
};
/* â˜… è€å¸« emailï¼ˆå¯å¤šå€‹ï¼‰*/
const ADMINS = ["019@tpjh.kh.edu.tw"];  // â† æ”¹æˆä½ çš„ email

const app  = initializeApp(FB);
const auth = getAuth(app);
const db   = getFirestore(app);
const prov = new GoogleAuthProvider();

/* helpers */
const $ = id => document.getElementById(id);
const toast = (msg, type="ok") => {
  const t=$("toast"); t.textContent=msg; t.className=`toast ${type} show`;
  setTimeout(()=>t.classList.remove("show"),2800);
};
const cm = id => $(id).classList.add("hidden");
window.cm = cm;
window.mbg = (e,id) => { if(e.target===$(id)) cm(id); };

const TYPE_LBL = {hw:"ä½œæ¥­",exam:"è€ƒè©¦",perf:"å¹³æ™‚è¡¨ç¾",att:"å‡ºç¼ºå‹¤"};
const TYPE_CLR = {hw:"bb",exam:"br",perf:"bg",att:"by"};

let ME = null;
let classes = [];  // [{id,name}]
let stuCache = []; // [{id,seat,name,class}]

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• AUTH â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
window.doSignIn = async () => {
  try { await signInWithPopup(auth, prov); }
  catch(e){ $("loginErr").textContent="ç™»å…¥å¤±æ•—ï¼š"+e.message; }
};
window.doSignOut = () => fbOut(auth);

onAuthStateChanged(auth, async user => {
  ME = user;
  if(!user){ showS("login"); return; }
  await loadClasses();

  if(ADMINS.map(e=>e.toLowerCase()).includes(user.email.toLowerCase())){
    $("adminAvatar").src = user.photoURL||"";
    $("adminName").textContent = user.displayName||user.email;
    await loadStuCache();
    populateSelects();
    loadAsgList(); loadStuList(); loadBindList(); renderClsList();
    seLoadItems();
    showS("admin");
  } else {
    const binding = await getBinding(user.uid);
    if(binding){ await showStudentScreen(user, binding); }
    else { showBindScreen(user); }
  }
});

function showS(s){
  ["login","bind","student","admin"].forEach(n => $(s==="login"?`S-login`:s==="bind"?`S-bind`:s==="student"?`S-student`:`S-admin`).classList.add("hidden"));
  $(`S-${s}`).classList.remove("hidden");
}
// Simplified version:
function showScreen(s){
  document.querySelectorAll("[id^='S-']").forEach(el=>el.classList.add("hidden"));
  $(`S-${s}`).classList.remove("hidden");
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• CLASSES â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function loadClasses(){
  const snap = await getDocs(collection(db,"classes"));
  classes = snap.docs.map(d=>({id:d.id,...d.data()}));
  if(classes.length===0){
    const batch = writeBatch(db);
    ["804","806","705"].forEach(name=>{
      batch.set(doc(collection(db,"classes")),{name,createdAt:serverTimestamp()});
    });
    await batch.commit();
    const snap2 = await getDocs(collection(db,"classes"));
    classes = snap2.docs.map(d=>({id:d.id,...d.data()}));
  }
}

async function loadStuCache(){
  const snap = await getDocs(collection(db,"students"));
  stuCache = snap.docs.map(d=>({id:d.id,...d.data()}));
}

function populateSelects(){
  const allOpt = `<option value="">å…¨éƒ¨ç­ç´š</option>`;
  const opts = classes.map(c=>`<option value="${c.id}">${c.name}</option>`).join("");
  // score entry
  if($("seClass")) $("seClass").innerHTML = opts;
  // assignment modal
  if($("asgClass")) $("asgClass").innerHTML = classes.map(c=>`<option value="${c.name}">${c.name}</option>`).join("");
  // student modal
  if($("stuCls")) $("stuCls").innerHTML = classes.map(c=>`<option value="${c.name}">${c.name}</option>`).join("");
  // filters (with "all")
  if($("asgFilter")) $("asgFilter").innerHTML = allOpt+opts;
  if($("stuFilter")) $("stuFilter").innerHTML = allOpt+opts;
  if($("bindFilter")) $("bindFilter").innerHTML = allOpt+opts;
  // bind screen
  if($("bindClass")) $("bindClass").innerHTML = classes.map(c=>`<option value="${c.name}">${c.name}</option>`).join("");
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• BIND â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function getBinding(uid){
  const snap = await getDoc(doc(db,"bindings",uid));
  return snap.exists()?snap.data():null;
}

function showBindScreen(user){
  populateSelects();
  $("bindInfo").textContent = "Google å¸³è™Ÿï¼š"+user.email;
  showScreen("bind");
}

window.doBind = async () => {
  const clsName = $("bindClass").value;
  const seat    = parseInt($("bindSeat").value);
  const name    = $("bindName").value.trim();
  if(!clsName||!seat||!name){ $("bindErr").textContent="è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½"; return; }
  const q = query(collection(db,"students"),where("class","==",clsName),where("seat","==",seat));
  const snap = await getDocs(q);
  if(snap.empty){ $("bindErr").textContent="æŸ¥ç„¡æ­¤ç­ç´šåº§è™Ÿï¼Œè«‹ç¢ºèªæˆ–è¯çµ¡è€å¸«"; return; }
  const stuDoc = snap.docs[0];
  if(stuDoc.data().name!==name){ $("bindErr").textContent="å§“åä¸ç¬¦ï¼Œè«‹ç¢ºèª"; return; }
  await setDoc(doc(db,"bindings",ME.uid),{
    uid:ME.uid, email:ME.email, studentId:stuDoc.id,
    className:clsName, seat, name, boundAt:serverTimestamp()
  });
  await showStudentScreen(ME,{studentId:stuDoc.id,className:clsName,seat,name});
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• STUDENT VIEW â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let stuAllScores = [];
let stuCurType = "hw";

async function showStudentScreen(user, binding){
  $("stuEmail").textContent = user.email;
  $("stuInfoName").textContent = binding.name;
  $("stuInfoMeta").textContent = `${binding.className} ç­ãƒ»ç¬¬ ${binding.seat} è™Ÿ`;
  showScreen("student");

  const asgQ = query(collection(db,"assignments"),where("class","==",binding.className));
  const asgSnap = await getDocs(asgQ);
  const asgs = {};
  asgSnap.forEach(d=>{ asgs[d.id]={...d.data(),id:d.id}; });

  const scQ = query(collection(db,"scores"),where("studentId","==",binding.studentId));
  const scSnap = await getDocs(scQ);
  const scMap = {};
  scSnap.forEach(d=>{ scMap[d.data().assignmentId]=d.data().score; });

  stuAllScores = Object.values(asgs).map(a=>({...a, score: scMap[a.id]??null}));
  renderStuScores();
}

window.stuSwitchTab = (el, type) => {
  stuCurType = type;
  document.querySelectorAll("#S-student .tab").forEach(t=>t.classList.remove("active"));
  el.classList.add("active");
  renderStuScores();
};

function renderStuScores(){
  const filtered = stuAllScores.filter(a=>a.type===stuCurType);
  const list = $("stuScoreList"), empty = $("stuEmpty");
  if(!filtered.length){ list.innerHTML=""; empty.classList.remove("hidden"); return; }
  empty.classList.add("hidden");
  list.innerHTML = filtered.map(a=>{
    const s=a.score, has=s!==null;
    const pct = has?s/a.maxScore:0;
    const cls = !has?"pts-none":pct>=.8?"pts-high":pct>=.6?"pts-mid":"pts-low";
    const disp = has?`${s}<span style="font-size:11px;color:var(--t3)">/${a.maxScore}</span>`:"æœªç™»éŒ„";
    return `<div class="stu-score-item">
      <div style="flex:1">
        <div style="font-weight:600;">${a.name}</div>
        <div style="font-size:11px;color:var(--t3);margin-top:2px;">${TYPE_LBL[a.type]||a.type}</div>
      </div>
      <div class="pts ${cls}">${disp}</div>
    </div>`;
  }).join("");
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• NAV â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
window.navTo = page => {
  document.querySelectorAll(".nav-item").forEach(el=>el.classList.toggle("active",el.dataset.page===page));
  document.querySelectorAll(".page").forEach(el=>el.classList.toggle("active",el.id==="page-"+page));
  if(page==="assignments") loadAsgList();
  if(page==="students")    loadStuList();
  if(page==="bindings")    loadBindList();
  if(page==="classes")     renderClsList();
  if(page==="scoreEntry")  seLoadItems();
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• CLASSES PAGE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
window.openClsModal = ()=>{ $("clsName").value=""; $("M-cls").classList.remove("hidden"); };
window.saveCls = async()=>{
  const name=$("clsName").value.trim();
  if(!name){ toast("è«‹è¼¸å…¥åç¨±","err"); return; }
  if(classes.find(c=>c.name===name)){ toast("å·²å­˜åœ¨","err"); return; }
  await setDoc(doc(collection(db,"classes")),{name,createdAt:serverTimestamp()});
  toast("å·²æ–°å¢ "+name); cm("M-cls");
  await loadClasses(); populateSelects(); renderClsList();
};
window.deleteCls = async(id,name)=>{
  if(!confirm(`åˆªé™¤ã€Œ${name}ã€ç­ï¼Ÿ`)) return;
  await deleteDoc(doc(db,"classes",id));
  toast("å·²åˆªé™¤"); await loadClasses(); populateSelects(); renderClsList();
};
function renderClsList(){
  const el=$("clsList");
  if(!classes.length){ el.innerHTML='<div style="text-align:center;color:var(--t3);padding:40px;">å°šç„¡ç­ç´š</div>'; return; }
  el.innerHTML=classes.map(c=>`
    <div style="display:flex;align-items:center;background:var(--s2);border:1px solid var(--b1);border-radius:var(--rs);padding:14px 18px;">
      <span style="font-size:20px;font-weight:700;font-family:'JetBrains Mono',monospace;color:var(--t1);">${c.name}</span>
      <span style="margin-left:8px;color:var(--t3);font-size:13px;">ç­</span>
      <div style="margin-left:auto;display:flex;gap:8px;">
        <button class="btn btn-danger btn-sm" onclick="deleteCls('${c.id}','${c.name}')">åˆªé™¤</button>
      </div>
    </div>`).join("");
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ASSIGNMENTS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let editAsgId=null;
window.openAsgModal=(id=null)=>{
  editAsgId=id;
  $("asgMT").textContent=id?"ç·¨è¼¯é …ç›®":"æ–°å¢é …ç›®";
  if(!id){ $("asgName").value=""; $("asgType").value="hw"; $("asgMax").value=100; }
  $("asgClass").innerHTML=classes.map(c=>`<option value="${c.name}">${c.name}</option>`).join("");
  $("M-asg").classList.remove("hidden");
};
window.saveAsg=async()=>{
  const name=$("asgName").value.trim(), type=$("asgType").value,
        cls=$("asgClass").value, max=parseInt($("asgMax").value)||100;
  if(!name||!cls){ toast("è«‹å¡«å¯«åç¨±","err"); return; }
  const id=editAsgId||doc(collection(db,"assignments")).id;
  await setDoc(doc(db,"assignments",id),{name,type,class:cls,maxScore:max,createdAt:serverTimestamp()});
  toast(editAsgId?"å·²æ›´æ–°":"å·²æ–°å¢"); cm("M-asg"); loadAsgList(); seLoadItems();
};
window.deleteAsg=async(id,name)=>{
  if(!confirm(`åˆªé™¤ã€Œ${name}ã€ï¼Ÿç›¸é—œæˆç¸¾ä¹Ÿæœƒåˆªé™¤ã€‚`)) return;
  const batch=writeBatch(db);
  batch.delete(doc(db,"assignments",id));
  const scSnap=await getDocs(query(collection(db,"scores"),where("assignmentId","==",id)));
  scSnap.forEach(d=>batch.delete(d.ref));
  await batch.commit(); toast("å·²åˆªé™¤"); loadAsgList();
};
async function loadAsgList(){
  const fid=$("asgFilter")?.value;
  const fcls=classes.find(c=>c.id===fid)?.name||"";
  const q=fcls?query(collection(db,"assignments"),where("class","==",fcls)):collection(db,"assignments");
  const snap=await getDocs(q);
  const tbody=$("asgTbody");
  if(snap.empty){ tbody.innerHTML=`<tr><td colspan="6" style="text-align:center;color:var(--t3);padding:28px;">å°šç„¡é …ç›®</td></tr>`; return; }
  tbody.innerHTML=snap.docs.map(d=>{
    const a=d.data(), dt=a.createdAt?.toDate?.()?.toLocaleDateString("zh-TW")||"â€”";
    return `<tr>
      <td><strong>${a.name}</strong></td>
      <td><span class="badge ${TYPE_CLR[a.type]||'bgr'}">${TYPE_LBL[a.type]||a.type}</span></td>
      <td><span class="badge bb">${a.class}</span></td>
      <td class="mono">${a.maxScore}</td>
      <td style="color:var(--t3);font-size:12px;">${dt}</td>
      <td><button class="btn btn-danger btn-xs" onclick="deleteAsg('${d.id}','${a.name}')">åˆªé™¤</button></td>
    </tr>`;
  }).join("");
}
window.loadAsgList=loadAsgList;

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SCORE ENTRY â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
window.seLoadItems=async()=>{
  const cid=$("seClass")?.value;
  const cls=classes.find(c=>c.id===cid)?.name||"";
  const sel=$("seItem"); if(!sel) return;
  if(!cls){ sel.innerHTML='<option>è«‹é¸ç­ç´š</option>'; return; }
  const snap=await getDocs(query(collection(db,"assignments"),where("class","==",cls)));
  if(snap.empty){ sel.innerHTML='<option>æ­¤ç­å°šç„¡é …ç›®</option>'; $("seSheet").innerHTML='<div style="text-align:center;padding:48px;color:var(--t3);">è«‹å…ˆåœ¨ã€Œä½œæ¥­ç®¡ç†ã€æ–°å¢é …ç›®</div>'; return; }
  sel.innerHTML=snap.docs.map(d=>`<option value="${d.id}">${d.data().name}ï¼ˆ${TYPE_LBL[d.data().type]}ï¼‰</option>`).join("");
  seLoadSheet();
};

window.seLoadSheet=async()=>{
  const asgId=$("seItem")?.value;
  const cid=$("seClass")?.value;
  const cls=classes.find(c=>c.id===cid)?.name||"";
  if(!asgId||!cls) return;
  const asg=(await getDoc(doc(db,"assignments",asgId))).data();
  if(!asg) return;

  const stuSnap=await getDocs(query(collection(db,"students"),where("class","==",cls),orderBy("seat")));
  const stus=stuSnap.docs.map(d=>({id:d.id,...d.data()}));

  const scSnap=await getDocs(query(collection(db,"scores"),where("assignmentId","==",asgId)));
  const scMap={};
  scSnap.forEach(d=>{ scMap[d.data().studentId]=d.data().score; });

  if(!stus.length){ $("seSheet").innerHTML='<div style="text-align:center;padding:48px;color:var(--t3);">æ­¤ç­å°šç„¡å­¸ç”Ÿ</div>'; return; }

  $("seSheet").innerHTML=`
    <div class="tbl-wrap">
      <table>
        <thead><tr><th>åº§è™Ÿ</th><th>å§“å</th><th>åˆ†æ•¸ <span style="color:var(--t3);font-weight:400">/ ${asg.maxScore}</span></th><th>ç‹€æ…‹</th></tr></thead>
        <tbody>${stus.map(s=>{
          const sc=scMap[s.id], has=sc!==undefined;
          return `<tr>
            <td class="mono" style="color:var(--t3);">${s.seat}</td>
            <td><strong>${s.name}</strong></td>
            <td><input class="si ${has?'filled':''}" type="number" data-sid="${s.id}"
              min="0" max="${asg.maxScore}" value="${has?sc:''}" placeholder="â€”"
              oninput="this.classList.toggle('filled',this.value!=='');calcAvg()"></td>
            <td id="ss-${s.id}" style="font-size:12px;">${has?'<span style="color:var(--grn)">âœ“</span>':'<span style="color:var(--t3)">â€”</span>'}</td>
          </tr>`;
        }).join("")}</tbody>
        <tfoot><tr>
          <td colspan="2" style="text-align:right;">å…¨ç­å¹³å‡ï¼ˆå·²å¡«ï¼‰</td>
          <td id="avgCell">â€”</td><td></td>
        </tr></tfoot>
      </table>
    </div>`;
  calcAvg();
};

window.calcAvg=()=>{
  const vals=[...document.querySelectorAll(".si")].map(i=>i.value).filter(v=>v!=="").map(Number);
  const c=$("avgCell"); if(!c) return;
  c.textContent=vals.length?(vals.reduce((a,b)=>a+b,0)/vals.length).toFixed(1):"â€”";
};

window.seSave=async()=>{
  const asgId=$("seItem")?.value; if(!asgId){ toast("è«‹é¸æ“‡é …ç›®","err"); return; }
  const batch=writeBatch(db); let n=0;
  document.querySelectorAll(".si").forEach(inp=>{
    if(inp.value==="") return;
    const sid=inp.dataset.sid, score=parseFloat(inp.value);
    batch.set(doc(db,"scores",`${asgId}_${sid}`),{assignmentId:asgId,studentId:sid,score,updatedAt:serverTimestamp()});
    const ss=$(`ss-${sid}`); if(ss) ss.innerHTML='<span style="color:var(--grn)">âœ“</span>';
    n++;
  });
  await batch.commit(); toast(`å·²å„²å­˜ ${n} ç­†`);
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• STUDENTS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let editStuId=null;
window.openStuModal=(id=null)=>{
  editStuId=id;
  $("stuMT").textContent=id?"ç·¨è¼¯å­¸ç”Ÿ":"æ–°å¢å­¸ç”Ÿ";
  $("stuCls").innerHTML=classes.map(c=>`<option value="${c.name}">${c.name}</option>`).join("");
  if(!id){ $("stuSeat").value=""; $("stuName2").value=""; }
  $("M-stu").classList.remove("hidden");
};
window.saveStu=async()=>{
  const cls=$("stuCls").value, seat=parseInt($("stuSeat").value), name=$("stuName2").value.trim();
  if(!cls||!seat||!name){ toast("è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½","err"); return; }
  const id=editStuId||`${cls}_${String(seat).padStart(2,"0")}`;
  await setDoc(doc(db,"students",id),{class:cls,seat,name});
  toast(editStuId?"å·²æ›´æ–°":"å·²æ–°å¢ "+name); cm("M-stu");
  await loadStuCache(); loadStuList();
};
window.deleteStu=async(id,name)=>{
  if(!confirm(`åˆªé™¤ã€Œ${name}ã€ï¼Ÿ`)) return;
  await deleteDoc(doc(db,"students",id));
  toast("å·²åˆªé™¤"); await loadStuCache(); loadStuList();
};
async function loadStuList(){
  const fid=$("stuFilter")?.value;
  const fcls=classes.find(c=>c.id===fid)?.name||"";
  const q=fcls?query(collection(db,"students"),where("class","==",fcls),orderBy("seat")):query(collection(db,"students"),orderBy("seat"));
  const snap=await getDocs(q);

  const bSnap=await getDocs(collection(db,"bindings"));
  const bMap={};
  bSnap.forEach(d=>{ bMap[d.data().studentId]=d.data().email; });

  const tbody=$("stuTbody");
  if(snap.empty){ tbody.innerHTML=`<tr><td colspan="5" style="text-align:center;color:var(--t3);padding:28px;">å°šç„¡å­¸ç”Ÿ</td></tr>`; return; }
  tbody.innerHTML=snap.docs.map(d=>{
    const s=d.data(), bound=bMap[d.id];
    return `<tr>
      <td class="mono" style="color:var(--t3);">${s.seat}</td>
      <td><strong>${s.name}</strong></td>
      <td><span class="badge bb">${s.class}</span></td>
      <td>${bound?`<span class="badge bg">âœ“ å·²ç¶å®š</span>`:`<span class="badge bgr">æœªç¶å®š</span>`}</td>
      <td style="display:flex;gap:6px;">
        <button class="btn btn-ghost btn-xs" onclick="openStuModal('${d.id}')">ç·¨è¼¯</button>
        <button class="btn btn-danger btn-xs" onclick="deleteStu('${d.id}','${s.name}')">åˆªé™¤</button>
      </td>
    </tr>`;
  }).join("");
}
window.loadStuList=loadStuList;

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• IMPORT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
window.openImportModal=()=>{ $("importTxt").value=""; $("importResult").innerHTML=""; $("M-import").classList.remove("hidden"); };
window.runImport=async()=>{
  const lines=$("importTxt").value.trim().split("\n").filter(l=>l.trim());
  if(!lines.length){ toast("è«‹è²¼ä¸Šåå–®","err"); return; }
  const batch=writeBatch(db); let ok=0,fail=0,html="";
  for(const line of lines){
    const p=line.trim().split(/\s+/);
    if(p.length<3){ html+=`<div style="color:var(--red)">âœ• æ ¼å¼éŒ¯èª¤ï¼š${line}</div>`; fail++; continue; }
    const [seat,name,cls]=p, sn=parseInt(seat);
    if(!sn||!name||!cls){ html+=`<div style="color:var(--red)">âœ• è³‡æ–™æœ‰èª¤ï¼š${line}</div>`; fail++; continue; }
    batch.set(doc(db,"students",`${cls}_${String(sn).padStart(2,"0")}`),{class:cls,seat:sn,name});
    html+=`<div style="color:var(--grn)">âœ“ ${cls} ç¬¬${sn}è™Ÿ ${name}</div>`; ok++;
  }
  await batch.commit();
  $("importResult").innerHTML=`<div style="margin-bottom:6px;color:var(--t1);">å®Œæˆï¼šâœ“${ok} âœ•${fail}</div>`+html;
  toast(`åŒ¯å…¥ ${ok} ç­†`); await loadStuCache(); loadStuList();
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• BINDINGS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function loadBindList(){
  const fid=$("bindFilter")?.value;
  const fcls=classes.find(c=>c.id===fid)?.name||"";
  const bSnap=await getDocs(collection(db,"bindings"));
  const binds=bSnap.docs.map(d=>({uid:d.id,...d.data()}));
  const filtered=fcls?binds.filter(b=>b.className===fcls):binds;

  const tbody=$("bindTbody");
  if(!filtered.length){ tbody.innerHTML=`<tr><td colspan="6" style="text-align:center;color:var(--t3);padding:28px;">å°šç„¡ç¶å®šè³‡æ–™</td></tr>`; return; }
  tbody.innerHTML=filtered.map(b=>{
    const dt=b.boundAt?.toDate?.()?.toLocaleDateString("zh-TW")||"â€”";
    return `<tr>
      <td class="mono" style="color:var(--t3);">${b.seat}</td>
      <td><strong>${b.name}</strong></td>
      <td><span class="badge bb">${b.className}</span></td>
      <td style="font-family:'JetBrains Mono',monospace;font-size:12px;color:var(--acc2);">${b.email}</td>
      <td style="color:var(--t3);font-size:12px;">${dt}</td>
      <td style="display:flex;gap:6px;">
        <button class="btn btn-ghost btn-xs" onclick="openRebind('${b.uid}','${b.email}')">ä¿®æ”¹</button>
        <button class="btn btn-danger btn-xs" onclick="removeBind('${b.uid}','${b.name}')">ç§»é™¤</button>
      </td>
    </tr>`;
  }).join("");
}
window.loadBindList=loadBindList;

window.removeBind=async(uid,name)=>{
  if(!confirm(`ç§»é™¤ã€Œ${name}ã€çš„ç¶å®šï¼Ÿ`)) return;
  await deleteDoc(doc(db,"bindings",uid));
  toast("å·²ç§»é™¤"); loadBindList(); loadStuList();
};
window.openRebind=(uid,email)=>{ $("rebindUid").value=uid; $("rebindEmail").value=email; $("M-rebind").classList.remove("hidden"); };
window.saveRebind=async()=>{
  const uid=$("rebindUid").value, email=$("rebindEmail").value.trim().toLowerCase();
  if(!email){ toast("è«‹è¼¸å…¥ Email","err"); return; }
  const snap=await getDoc(doc(db,"bindings",uid));
  if(!snap.exists()) return;
  await setDoc(doc(db,"bindings",uid),{...snap.data(),email,updatedAt:serverTimestamp()});
  toast("å·²æ›´æ–°"); cm("M-rebind"); loadBindList();
};
</script>
</body>
</html>
